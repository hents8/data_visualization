<div class="temporal-chart">
    <div class="temporal-chart-header">
        <h2>Évolution des tonalités dans le temps</h2>
    </div>
    <canvas id="{{ id }}"></canvas>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('{{ id }}').getContext('2d');

    // Labels X : tous les mois exacts triés
    const labels = {{ tonalityByYearMonth|keys|sort|json_encode|raw }};

    // Tonalités
    const tonalites = {{ tonaliteLabels|json_encode|raw }};

    // Données pour chaque tonalité
    const dataTimeline = {{ tonalityByYearMonth|json_encode|raw }};
    const datasets = tonalites.map((tone, idx) => ({
        label: tone,
        data: labels.map(month => dataTimeline[month][tone] ?? 0),
        borderWidth: 2,
        tension: 0.3,
        fill: false,
        borderColor:
            tone === 'Positif' ? '#2ecc71' :
            tone === 'Neutre'  ? '#f1c40f' :
            '#e74c3c',
        backgroundColor: 'transparent'
    }));

    new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 5,
                        maxTicksLimit: 6,
                        font: { size: 11 },
                        padding: 4
                    }
                },
                x: {
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45,
                        autoSkip: true
                    }
                }
            }
        }
    });
});
</script>
