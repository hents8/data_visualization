{% extends 'base.html.twig' %}

{% block title %}Dashboard{% endblock %}

{% block body %}
<div class="dashboard">
    <h1>Dashboard Veille Média</h1>

 {# === GRAPHE TEMPOREL MENSUEL PAR ANNÉE === #}
    {% if monthlyTotalsByYear is not empty %}
        {% include 'components/chart_line.html.twig' with {
            id: 'chartMonthlyTotal',
            monthlyTotalsByYear: monthlyTotalsByYear,
            months: months
        } %}
    {% else %}
        <div class="panel" style="margin-bottom:30px;">
            <h2>Évolution mensuelle des réponses</h2>
            <p>Aucune donnée mensuelle disponible.</p>
        </div>
    {% endif %}
	
	{% if tonalitesTimeline is not empty %}
		{% include 'components/chart_line_tonality.html.twig' with {
			id: 'chartTonalityEvolution',
			tonalityByYearMonth: tonalitesTimeline,
			tonaliteLabels: tonaliteLabels
		} %}
	{% else %}
        <div class="panel" style="margin-bottom:30px;">
            <h2>Évolution des tonalités dans le temps</h2>
            <p>Aucune donnée mensuelle disponible.</p>
        </div>
	{% endif %}



    <div class="page-container">

        {# === PANEL GAUCHE === #}
        <section class="panel">
            <h2>Panel Gauche</h2>

            <form method="get">
                <input type="hidden" name="year_right" value="{{ selectedYearRight }}">
                <input type="hidden" name="month_right" value="{{ selectedMonthRight }}">

                <label>Année</label>
                <select name="year_left" onchange="this.form.submit()">
                    <option value="">-- Tous --</option>
                    {% for y in years %}
                        <option value="{{ y }}" {{ y == selectedYearLeft ? 'selected' : '' }}>{{ y }}</option>
                    {% endfor %}
                </select>
                
                <label>Mois</label>
                <select name="month_left" onchange="this.form.submit()">
                    <option value="">-- Tous --</option>
                    {% for num, name in months %}
                        <option value="{{ num }}" {{ num == selectedMonthLeft ? 'selected' : '' }}>{{ name }}</option>
                    {% endfor %}
                </select>
            </form>

            {% for question, result in resultsLeft %}
                <h3>{{ question }}</h3>

                {% if result.labels is not empty and result.frequencies is not empty %}
                    {% set chartType = (question in ['Media','Citée','Tonalité']) ? 'doughnut' : 'bar' %}
                    {% if chartType == 'doughnut' %}
                        {% include 'components/chart_doughnut.html.twig' with {
                            labels: result.labels,
                            data: result.frequencies,
                            id: 'chartLeft' ~ loop.index
                        } %}
                    {% else %}
                        {% include 'components/chart.html.twig' with {
                            labels: result.labels,
                            data: result.frequencies,
                            id: 'chartLeft' ~ loop.index
                        } %}
                    {% endif %}

                    {% include 'components/kpi.html.twig' with {
                        title: 'Total réponses',
                        value: result.totalResponses
                    } %}
                {% else %}
                    <p>Aucune donnée pour cette sélection.</p>
                {% endif %}
            {% endfor %}
			
		{% if mediaTonaliteDatasetsLeft is not empty %}
			
				<h3>Media × Tonalité</h3>

				{% include 'components/chart_stacked_tona_media.html.twig' with {
					id: 'mediaTonaliteLeft',
					mediaLabels: mediaLabelsLeft,
					tonaliteDatasets: mediaTonaliteDatasetsLeft
				} %}

				{% set totalMediaTonalite = 0 %}
				{% for ds in mediaTonaliteDatasetsLeft %}
					{% for value in ds.data %}
						{% set totalMediaTonalite = totalMediaTonalite + value %}
					{% endfor %}
				{% endfor %}

				{% include 'components/kpi.html.twig' with {
					title: 'Total réponses',
					value: totalMediaTonalite
				} %}
			
		{% else %}
			<p>Aucune donnée Media × Tonalité pour cette sélection.</p>
		{% endif %}

			
        </section>

        {# === PANEL DROIT === #}
        <section class="panel">
            <h2>Panel Droit</h2>

            <form method="get">
                <input type="hidden" name="year_left" value="{{ selectedYearLeft }}">
                <input type="hidden" name="month_left" value="{{ selectedMonthLeft }}">

                <label>Année</label>
                <select name="year_right" onchange="this.form.submit()">
                    <option value="">-- Tous --</option>
                    {% for y in years %}
                        <option value="{{ y }}" {{ y == selectedYearRight ? 'selected' : '' }}>{{ y }}</option>
                    {% endfor %}
                </select>
                
                <label>Mois</label>
                <select name="month_right" onchange="this.form.submit()">
                    <option value="">-- Tous --</option>
                    {% for num, name in months %}
                        <option value="{{ num }}" {{ num == selectedMonthRight ? 'selected' : '' }}>{{ name }}</option>
                    {% endfor %}
                </select>
            </form>

            {% for question, result in resultsRight %}
                <h3>{{ question }}</h3>

                {% if result.labels is not empty and result.frequencies is not empty %}
                    {% set chartType = (question in ['Media','Citée','Tonalité']) ? 'doughnut' : 'bar' %}
                    {% if chartType == 'doughnut' %}
                        {% include 'components/chart_doughnut.html.twig' with {
                            labels: result.labels,
                            data: result.frequencies,
                            id: 'chartRight' ~ loop.index
                        } %}
                    {% else %}
                        {% include 'components/chart.html.twig' with {
                            labels: result.labels,
                            data: result.frequencies,
                            id: 'chartRight' ~ loop.index
                        } %}
                    {% endif %}

                    {% include 'components/kpi.html.twig' with {
                        title: 'Total réponses',
                        value: result.totalResponses
                    } %}
                {% else %}
                    <p>Aucune donnée pour cette sélection.</p>
                {% endif %}
            {% endfor %}
			
			{% if mediaTonaliteDatasetsRight is not empty %}
			
				<h3>Media × Tonalité</h3>

				{% include 'components/chart_stacked_tona_media.html.twig' with {
					id: 'mediaTonaliteRight',
					mediaLabels: mediaLabelsRight,
					tonaliteDatasets: mediaTonaliteDatasetsRight
				} %}

				{% set totalMediaTonalite = 0 %}
				{% for ds in mediaTonaliteDatasetsRight %}
					{% for value in ds.data %}
						{% set totalMediaTonalite = totalMediaTonalite + value %}
					{% endfor %}
				{% endfor %}

				{% include 'components/kpi.html.twig' with {
					title: 'Total réponses',
					value: totalMediaTonalite
				} %}
			
		{% else %}
			<p>Aucune donnée Media × Tonalité pour cette sélection.</p>
		{% endif %}
        </section>

    </div>
</div>
{% endblock %}
